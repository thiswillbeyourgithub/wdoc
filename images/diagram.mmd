flowchart TD
    subgraph CommonInput["Common Input"]
        Path["Path"]
    end

    Embeddings["Embedding providers<br/>OpenAI/Cohere/HF"]
    VectorStore["VectorStore<br/>(CompressedFaiss/BinaryFaiss)"]
    Chunker["Chunker<br/>Text splitting"]

    Path --> Chunker
    Chunker --> VectorStore
    Embeddings --> VectorStore

    subgraph QueryTask["task=query"]
        UserQuery["User Query"]
        TopK["TopK"]
        Raphael["Raphael the Rephraser<br/>Query expansion"]
        Eve["Eve the Evaluator<br/>Document filtering"]
        Anna["Anna the Answerer<br/>Per-doc answers"]
        
        subgraph RecursiveCombining["Recursive Combining"]
            SemanticBatching["Semantic batching"]
            Carl["Carl the Combiner<br/>Answer combination"]
            SemanticBatching --> Carl
        end
        
        QueryOutput["General Output"]
        
        UserQuery --> Raphael
        Raphael --> Embeddings
        TopK -->|ex: top_k=50| VectorStore
        VectorStore -->|50 docs| Eve
        Eve -->|37 docs| Anna
        Anna -->|37 answers| RecursiveCombining
        Carl -->|1 answer| QueryOutput
    end

    subgraph SummaryTask["task=summary"]
        ChunkExample["ex: 17 chunks"]
        Sam["Sam the Summarizer<br/>Document summary"]
        Concatenation["Concatenation"]
        SummaryOutput["wdocSummary object"]
        
        Chunker --> ChunkExample
        ChunkExample --> Sam
        Sam -->|17 overlapping<br/>chunk summaries| Concatenation
        Concatenation --> SummaryOutput
    end
